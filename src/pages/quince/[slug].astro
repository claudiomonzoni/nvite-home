---
import matter from 'gray-matter';
import { useTranslations, type ui } from "../../i18n/ui";
import Layout from "../../layouts/quince/Layout.astro";

//componentes
import Hero from "../../components/quince/Hero";
import AudioPlayer from "../../components/quince/Audio.astro";
import ProgresoInvitados from "../../components/comunes/ProgresoInvitados.astro";
import MensajeVip from "../../components/comunes/MensajeVip.astro";
import Encabezados from "../../components/quince/Encabezados.astro";
import Cartas from "../../components/quince/Cartas.astro";
import Frase from "../../components/quince/Frase.astro";
import SilderGsap from "../../components/comunes/SilderGsap.astro";
import BloqueMapa from "../../components/quince/BloqueMapa.astro";
import Regalos from "../../components/comunes/Regalos.astro";
import Contador from "../../components/quince/Contador.astro";
import Itinerario from "../../components/quince/Itinerario.astro";
import Confirmacion from "../../components/comunes/Confirmacion";  
import ConfirmacionBasica from "../../components/quince/ConfirmacionBasica";  
import FotoSolitaria from "../../components/comunes/FotoSolitaria.astro";
import Padres from '../../components/quince/Padres.astro';
import Footer from "../../components/quince/Footer.astro";
import Padrinos from '../../components/comunes/Padrinos.astro';

// SSR: fetch MDX/frontmatter from GitHub Raw using the slug on every request
const slug = Astro.params.slug as string;
if (!slug) {
  throw new Error('Slug no proporcionado');
}

// Evitar cache del HTML en el CDN/cliente
Astro.response.headers.set('Cache-Control', 's-maxage=10, stale-while-revalidate');

const owner = 'claudiomonzoni';
const repo = 'nvite-home';
const branch = 'master';

// Helper para agregar query param
const withParam = (url: string, key: string, val: string) => url + (url.includes('?') ? '&' : '?') + `${key}=${encodeURIComponent(val)}`;
const cacheBust = Date.now().toString();

// Helper para convertir rutas públicas a GitHub Raw URLs
const toRawUrl = (maybePath: string | undefined): string | undefined => {
  if (!maybePath) return undefined;
  // Si ya es URL absoluta, dejarla igual
  try { new URL(maybePath); return maybePath; } catch {}
  // Normalizar prefijo
  const p = maybePath.startsWith('/') ? maybePath : `/${maybePath}`;
  // Keystatic guarda imágenes en public/* y expone con publicPath que empieza con "/..."
  // Las serviremos directamente desde GitHub raw para evitar redeploys
  const base = `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/public${p}`;
  return withParam(base, 'v', cacheBust);
};

// Descarga del archivo MDX
let mdxUrl = `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/src/content/quince/${slug}.mdx`;
mdxUrl = withParam(mdxUrl, 'v', cacheBust);
const headers: Record<string, string> = {};
const token = import.meta.env.GITHUB_TOKEN || process.env.GITHUB_TOKEN;
if (token) headers.Authorization = `Bearer ${token}`;

const res = await fetch(mdxUrl, { headers });
if (!res.ok) {
  return Astro.redirect('/404');
}
const mdxRaw = await res.text();

// Parsear frontmatter
const parsed = matter(mdxRaw);
const fm = parsed.data as any;

// Normalizar datos esperados por la página
const quince = {
  id: slug,
  data: {
    version: fm.version ?? '',
    idioma: fm.idioma ?? 'es',
    draft: !!fm.draft,
    titulo: fm.titulo ?? slug,
    whatsapp: fm.whatsapp ?? '',
    email: fm.email ?? '',
    quinceanera: fm.quinceanera ?? '',
    padres: {
      mama: fm?.padres?.mama ?? '',
      papa: fm?.padres?.papa ?? '',
      fotopapas: toRawUrl(fm?.padres?.fotopapas) ?? '',
    },
    padrinos: Array.isArray(fm?.padrinos) ? fm.padrinos : [],
    fecha: fm.fecha ? new Date(fm.fecha) : new Date(),
    frase_amor: fm.frase_amor ?? '',
    ceremonia: {
      hora: fm?.ceremonia?.hora ?? '',
      lugar: fm?.ceremonia?.lugar ?? '',
      lat: fm?.ceremonia?.lat ?? '',
      lng: fm?.ceremonia?.lng ?? '',
    },
    recepcion: {
      hora: fm?.recepcion?.hora ?? '',
      lugar: fm?.recepcion?.lugar ?? '',
      lat: fm?.recepcion?.lat ?? '',
      lng: fm?.recepcion?.lng ?? '',
    },
    itinerario: Array.isArray(fm?.itinerario) ? fm.itinerario : [],
    cover: toRawUrl(fm.cover) ?? '',
    audioMusica: toRawUrl(fm.audioMusica) ?? '',
    galeria: Array.isArray(fm?.galeria) ? fm.galeria.map((p: string) => toRawUrl(p)) : [],
    imagenesSolitarias: Array.isArray(fm?.imagenesSolitarias) ? fm.imagenesSolitarias.map((p: string) => toRawUrl(p)) : [],
    frase_regalos: fm.frase_regalos ?? '',
    regalos: Array.isArray(fm?.regalos) ? fm.regalos : [],
    tipoRegalos: Array.isArray(fm?.tipoRegalos) ? fm.tipoRegalos : [],
    beneficiario: fm.beneficiario ?? '',
    banco: fm.banco ?? '',
    cuenta: fm.cuenta ?? '',
    progresoPorcentaje: typeof fm.progresoPorcentaje === 'number' ? fm.progresoPorcentaje : 20,
    progresoFrase: fm.progresoFrase ?? '¡Ya casi completamos la lista de invitados!',
    progresoMostrarSiempre: fm.progresoMostrarSiempre ?? true,
    consideraciones: Array.isArray(fm?.consideraciones) ? fm.consideraciones : [],
    vestimenta: fm.vestimenta ?? '',
    coloresVestimenta: Array.isArray(fm?.coloresVestimenta) ? fm.coloresVestimenta : [],
    paleta: fm.paleta ?? 'base',
    theme: fm.theme ?? { name: 'base' },
    content: parsed.content ?? '',
  }
} as any;

const base = new URL(Astro.url.pathname, Astro.site);
const Nfecha = new Date(quince.data.fecha);

const imagenesSolitarias: string[] = (quince.data as any).imagenesSolitarias ?? [];

// Tipado local para la galería
const galeria: string[] = (quince.data as any).galeria ?? [];
// Tipado y normalización local para mesas de regalos
type Mesa = { url: string; titulo: string };
const mesas: Mesa[] = ((quince.data as any).regalos ?? []).filter(
  (m: any): m is Mesa => typeof m?.url === 'string' && m.url && typeof m?.titulo === 'string' && m.titulo
);

const lang = (quince.data.idioma as keyof typeof ui) || 'es';
const t = useTranslations(lang);

---

<Layout
  title=`Invitación Xv años de ${quince.data.quinceanera}`
  url={base.toString()}
  cover={quince.data.cover}
  paleta={quince.data.paleta}
  theme={quince.data.theme}
>


<Hero
  nombres={quince.data.quinceanera}
  fecha={quince.data.fecha}
  cover={quince.data.cover}
  client:load
  lang={lang}
  labels={{
    loading: t('hero.loadingQuince'),
    tap: t('hero.tap'),
    honor: t('hero.quince.honor'),
    date: t('hero.quince.date'),
    share: t('hero.quince.share'),
    passes: t('hero.passes'),
  }}
/>

<Encabezados texto={t('quince.myFifteen')} />
  <section class="grid pantalla">
    <Padres
      mama={quince.data.padres.mama}
      papa={quince.data.padres.papa}
      fotopapas={quince.data.padres.fotopapas}
      labels={{
        blessing: t('quince.parents'),
        mother: t('parents.mother'),
        father: t('parents.father'),
      }}
    />
    <Padrinos
      nombres={quince.data.padrinos}
      labels={{
        title: t('godparents.title'),
      }}
    />
  </section>
  
{
    quince.data.version === "Lux" && quince.data.audioMusica && (
<section class="grid contenido">
  <AudioPlayer 
    src={quince.data.audioMusica} 
    labels={{
      listen: t('quince.audio.listen'),
    }}
  />
</section>
)
}


<!-- <ParrafosLibres
  texto="He soñado mucho con este día, y me llena de ilusión compartirlo contigo.
Para que no se te pase nada, revisa todos los detalles aquí abajo:"
/> -->



<section class="grid contenido">
  <Frase frase={quince.data.frase_amor} />
</section>

 <!-- Imágenes solitarias condicionales -->
  {
    imagenesSolitarias[0] && (
      <FotoSolitaria
        arriba={true}
        gradientePorciento={50}
        src={imagenesSolitarias[0]}
      />
    )
  }
<section class="grid contenido fondo-mitad">
  <!-- <ParrafosLibres
    texto="Te compartimos la ubicación, te esperamos en la ceremonia religiosa y en
      la fiesta de XV años, ¡No faltes!"
  /> -->
  <div id="zigzag">
    <BloqueMapa
      encabezado={t('invitation.ceremony')}
      dir={quince.data.ceremonia.lugar}
      horario={quince.data.ceremonia.hora}
      lat={quince.data.ceremonia.lat}
      lng={quince.data.ceremonia.lng}
      mapName="mapa1"
      labels={{
        startTrip: t('maps.startTrip'),
      }}
    />
    <BloqueMapa
      encabezado={t('invitation.reception')}
      dir={quince.data.recepcion.lugar}
      horario={quince.data.recepcion.hora}
      lat={quince.data.recepcion.lat}
      lng={quince.data.recepcion.lng}
      mapName="mapa2"
      labels={{
        startTrip: t('maps.startTrip'),
      }}
    />
  </div>
</section>

<section class="grid contenido">
  <div class="conte-cartas">
    <Cartas
    icono="mdi:list-status"
    titulo={t('invitation.details')}
    array={quince.data.consideraciones}
    />
    <Cartas
    icono="mdi:clothes-hanger"
    titulo={t('invitation.dressCode')}
    codigo={quince.data.vestimenta}
    />
    <Cartas
      icono="mdi:clipboard-text-date-outline"
      titulo={t('invitation.colorPalette')}
      tonos={quince.data.coloresVestimenta}
    />
  </div>
</section>

 <!-- Imágenes solitarias condicionales -->
  {
    imagenesSolitarias[1] && (
      <FotoSolitaria
        arriba={false}
        gradientePorciento={40}
        src={imagenesSolitarias[1]}
      />
    )
  }
<section class="grid contenido">
  <Contador 
    fecha={quince.data.fecha.toISOString().split('T')[0]} 
    labels={{
      days: t('countdown.days'),
      hours: t('countdown.hours'),
      minutes: t('countdown.minutes'),
      seconds: t('countdown.seconds'),
      onlyMissing: t('quince.countdown.onlyMissing'),
      thanks: t('quince.countdown.thanks'),
      day: t('quince.countdown.day'),
      onlyOne: t('quince.countdown.onlyOne'),
    }}
  />
</section>

{
    quince.data.version === "Lux" && (

<section class="grid pantalla">
  <ProgresoInvitados
    email={quince.data.email ?? "nvitacionluxquince@nvitaciones.com"}
    porcentajeMostrarInvitados={(quince.data.progresoPorcentaje ?? 20) as number}
    frase={quince.data.progresoFrase ?? t('invitation.rsvp.daysBefore')}
    mostrarSiempre={quince.data.progresoMostrarSiempre ?? true}
  />
</section>

<Itinerario listado={quince.data.itinerario} />
)
}

<section class="grid pantalla">
  <SilderGsap>
    {galeria && galeria.map((src) => (
      <img src={src} alt={`Galería de ${quince.data.quinceanera || 'XV Años'}`} loading="eager" />
    ))}
  </SilderGsap>
</section>


<section class="grid contenido">

  <Regalos
    tipo={quince.data.tipoRegalos}
    mesas={mesas}
    frase={quince.data.frase_regalos}
    beneficiario={quince.data.beneficiario}
    banco={quince.data.banco}
    cuenta={quince.data.cuenta}
    labels={{
      title: t('invitation.gifts'),
      stores: t('gifts.stores'),
      cash: t('gifts.cash'),
      transfers: t('gifts.transfer'),
      beneficiary: t('gifts.beneficiary'),
      bank: t('gifts.bank'),
      account: t('gifts.account')
    }}
    />
</section>

<section class="grid contenido">
  <MensajeVip 
    labels={{
      tag: t('vip.tag'),
    }}
  />
</section>


    {
      (() => {
        switch (quince.data.version) {
          case 'Lux':
          case 'Clasica':
            return (
              <Confirmacion
                whatsapp={quince.data.whatsapp}
                dias_antes={15}
                version={quince.data.version}
                tipo="quince"
                client:only="react"
                labels={{
                  title: t('invitation.rsvp'),
                  subtitle: t('invitation.rsvp.daysBefore'),
                  confirmYes: t('rsvp.confirmYes'),
                  confirmNo: t('rsvp.confirmNo'),
                  howMany: t('rsvp.howMany'),
                  selectPasses: t('rsvp.selectPasses'),
                  messageOptional: t('rsvp.messageOptional'),
                  messagePlaceholder: t('rsvp.messagePlaceholder'),
                  btnConfirm: t('rsvp.btnConfirm'),
                  btnDecline: t('rsvp.btnDecline'),
                  modalYes: t('rsvp.modalYes'),
                  modalNo: t('rsvp.modalNo'),
                  whatsappMsgYes: t('rsvp.whatsappMsgYes'),
                  whatsappMsgNo: t('rsvp.whatsappMsgNo'),
                  label: t('rsvp.label'),
                  moveSwitch: t('rsvp.moveSwitch'),
                  whoCanNotAttend: t('rsvp.whoCanNotAttend'),
                  whoCanNotAttendPlaceholder: t('rsvp.whoCanNotAttendPlaceholder'),
                  whoCanNotAttendNote: t('rsvp.whoCanNotAttendNote'),
                  importantNote: t('rsvp.importantNote'),
                  msgNoAttendFinal: t('rsvp.msgNoAttendFinal'),
                }}
/> 
            );
          case 'Esencial':
            return (
             <section>
                  <ConfirmacionBasica
                    whatsapp={quince.data.whatsapp}
                    dias_antes={15}      
                    client:only="react"
                    labels={{
                      title: t('invitation.rsvp'),
                      subtitle: t('invitation.rsvp.daysBefore'),
                      btnConfirm: t('rsvp.btnConfirm'),
                      whatsappMsg: t('rsvp.whatsappMsgYes'),
                      label: t('rsvp.label'),
                    }}
                  />
              </section>
            );
          default:
            return null;
        }
      })()
    }



  <section class="grid contenido">
    <Footer 
      ruta={base} 
      labels={{
        developedBy: t('footer.developedBy'),
        rights: t('footer.rights'),
        altLogo: t('footer.altLogo'),
      }}
    />
  </section>
</Layout>