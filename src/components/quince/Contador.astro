---
interface Props {
    fecha: string;
    labels?: {
        days?: string;
        hours?: string;
        minutes?: string;
        seconds?: string;
        onlyMissing?: string;
        thanks?: string;
        day?: string;
        onlyOne?: string;
    };
}

const { fecha, labels = {} } = Astro.props;

const l = {
    days: labels.days || "días",
    hours: labels.hours || "horas",
    minutes: labels.minutes || "minutos",
    seconds: labels.seconds || "segundos",
    onlyMissing: labels.onlyMissing || "Solo faltan:",
    thanks:
        labels.thanks ||
        "Gracias por ser parte de la celebración de mis XV años",
    day: labels.day || "Día",
    onlyOne: labels.onlyOne || "Solo falta",
};
---

<div id="demo"></div>
<div id="contador">
    <p id="falta">{l.onlyMissing}</p>
    <div class="tiempo-container">
        <div class="tiempo-item">
            <div id="dias-numero" class="numero"></div>
            <p id="dias-texto">{l.days}</p>
        </div>
        <div class="tiempo-item">
            <div id="horas-numero" class="numero"></div>
            <p>{l.hours}</p>
        </div>
        <div class="tiempo-item">
            <div id="minutos-numero" class="numero"></div>
            <p>{l.minutes}</p>
        </div>
        <div class="tiempo-item">
            <div id="segundos-numero" class="numero"></div>
            <p>{l.seconds}</p>
        </div>
    </div>
</div>

<script define:vars={{ fecha, l }}>
    function calcularTiempoRestante(fechaObjetivo) {
        try {
            const parts = fechaObjetivo.split("-");
            // Handle YYYY-MM-DD format manually to parse as local date (00:00:00)
            const year = parseInt(parts[0]);
            const month = parseInt(parts[1]);
            const day = parseInt(parts[2]);

            const targetDate = new Date(year, month - 1, day);
            const now = new Date();

            const diffTime = targetDate.getTime() - now.getTime();

            if (diffTime <= 0) {
                return { dias: 0, horas: 0, minutos: 0, segundos: 0 };
            }

            const dias = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            const horas = Math.floor(
                (diffTime % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60),
            );
            const minutos = Math.floor(
                (diffTime % (1000 * 60 * 60)) / (1000 * 60),
            );
            const segundos = Math.floor((diffTime % (1000 * 60)) / 1000);

            return { dias, horas, minutos, segundos };
        } catch (error) {
            console.error("Error calculating time:", error);
            return { dias: 0, horas: 0, minutos: 0, segundos: 0 };
        }
    }

    function actualizarContador() {
        const tiempo = calcularTiempoRestante(fecha);

        const diasElement = document.getElementById("dias-numero");
        const horasElement = document.getElementById("horas-numero");
        const minutosElement = document.getElementById("minutos-numero");
        const segundosElement = document.getElementById("segundos-numero");
        const contadorContainer = document.getElementById("contador");
        const demoElement = document.getElementById("demo");

        if (diasElement) diasElement.innerHTML = tiempo.dias;
        if (horasElement) horasElement.innerHTML = tiempo.horas;
        if (minutosElement) minutosElement.innerHTML = tiempo.minutos;
        if (segundosElement) segundosElement.innerHTML = tiempo.segundos;

        const faltaElement = document.getElementById("falta");
        const diasTexto = document.getElementById("dias-texto");

        if (
            tiempo.dias <= 0 &&
            tiempo.horas <= 0 &&
            tiempo.minutos <= 0 &&
            tiempo.segundos <= 0
        ) {
            if (contadorContainer) contadorContainer.style.display = "none";
            if (demoElement) {
                demoElement.style.display = "block";
                demoElement.innerHTML = l.thanks;
            }
            return;
        }

        if (tiempo.dias === 1) {
            if (diasTexto) diasTexto.innerHTML = l.day;
            if (faltaElement) faltaElement.innerHTML = l.onlyOne;
        } else {
            if (diasTexto) diasTexto.innerHTML = l.days;
            if (faltaElement) faltaElement.innerHTML = l.onlyMissing;
        }
    }

    actualizarContador();
    const intervalo = setInterval(actualizarContador, 1000);
    document.addEventListener("astro:before-swap", () =>
        clearInterval(intervalo),
    );
</script>
